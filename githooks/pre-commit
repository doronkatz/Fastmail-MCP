#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
COVERAGE_THRESHOLD="${COVERAGE_THRESHOLD:-80}"
PYTHON_BIN="${PYTHON_BIN:-python3}"

cd "$ROOT_DIR"

if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
  echo "pre-commit: ${PYTHON_BIN} not found; aborting commit." >&2
  exit 1
fi

echo "pre-commit: running unit tests with coverage >= ${COVERAGE_THRESHOLD}%"
"$PYTHON_BIN" -m pytest tests/ \
  -m "not slow" \
  --cov=fastmail_mcp \
  --cov-report=term-missing \
  --cov-fail-under="${COVERAGE_THRESHOLD}"
